rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // --- Helper Functions ---

    // Check if the request body contains valid repository fields
    function isValidRepository() {
      let data = request.resource.data;
      return data.name is string 
          && data.name.size() > 0
          && data.description is string
          && data.ownerId is string
          && data.ownerName is string
          && data.isPublic is bool
          && data.games is list
          && data.createdAt is number;
    }

    // --- Rules ---
    //
    // NOTE:
    // This projectâ€™s current identity model is username + device fingerprint (no Firebase Auth providers).
    // That means Firestore access must either:
    // - be proxied through server-side APIs (recommended), OR
    // - use permissive rules (dev-only; insecure and spoofable).

    // Username + fingerprint auth data (DEV-ONLY permissive rules)
    match /accounts/{username} {
      allow read, create, update: if true;
      allow delete: if false;

      match /challenges/{challengeId} {
        allow read, create, update: if true;
        allow delete: if false;
      }
    }

    // Per-device/per-user data (DEV-ONLY permissive rules)
    match /users/{uid} {
      allow read, create, update: if true;
      allow delete: if false;

      match /{document=**} {
        allow read, create, update: if true;
        allow delete: if false;
      }
    }

    // Social graph (DEV-ONLY permissive rules)
    match /friend_requests/{id} {
      allow read, create, update: if true;
      allow delete: if false;
    }

    match /friendships/{id} {
      allow read, create, update: if true;
      allow delete: if false;
    }

    // Archives (DEV-ONLY permissive rules)
    match /archives/{id} {
      allow read, create, update: if true;
      allow delete: if false;
    }

    // Game repositories (existing validation)
    match /game_repositories/{repoId} {
      // Allow reading if the repository is public
      allow read: if resource.data.isPublic == true;

      // DEV-ONLY: allow reading for app usability without Firebase Auth
      allow read: if true;

      // Allow creation if the data schema is valid
      allow create: if isValidRepository();

      // Allow updates if the schema remains valid
      allow update: if isValidRepository();

      // Prevent deletion for safety (unless you want to allow it)
      allow delete: if false;
    }
  }
}
